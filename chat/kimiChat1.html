<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimi智能助手</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <style>
        /* 样式部分保持不变 */
        :root {
            --primary-blue: #1e88e5;
            --light-blue: #e3f2fd;
            --dark-blue: #0d47a1;
            --text-dark: #333;
            --text-light: #fff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --success: #4caf50;
            --danger: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 导航栏样式 */
        .navbar {
            background-color: var(--primary-blue);
            color: var(--text-light);
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .logo {
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 28px;
        }
        
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .dropdown {
            position: relative;
        }
        
        .dropdown-toggle {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .dropdown-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .new-chat-btn {
            background-color: #ff9e00;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .new-chat-btn:hover {
            background-color: #f57c00;
            transform: translateY(-2px);
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 260px;
            background-color: white;
            height: calc(100vh - 60px);
            position: fixed;
            top: 60px;
            left: 0;
            overflow-y: auto;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        
        .history-section {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            text-transform: uppercase;
            font-size: 12px;
            font-weight: 600;
            color: #78909c;
            margin-bottom: 15px;
        }
        
        .history-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
        }
        
        .history-item:hover, .history-item.active {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }
        
        .history-item .delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            color: #e53935;
        }
        
        .history-item:hover .delete-btn {
            opacity: 1;
        }
        
        .assistant-section {
            padding: 20px 15px;
        }
        
        .assistant-options {
            list-style: none;
        }
        
        .assistant-option {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .assistant-option:hover, .assistant-option.active {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }
        
        .assistant-option i {
            width: 24px;
            text-align: center;
        }
        
        .settings-area {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #546e7a;
            font-weight: 500;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            height: calc(100vh - 60px);
            margin-top: 60px;
            margin-left: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* 消息容器 */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 85%;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #e3f2fd;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .message-header i {
            margin-right: 8px;
            font-size: 18px;
        }
        
    
        .formatted-content {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid var(--primary-blue);
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: bounce 1.3s linear infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .token-counter {
            text-align: right;
            font-size: 12px;
            color: #78909c;
            margin-top: 8px;
        }
        
        /* 相似话题推荐 */
        .similar-topics {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .similar-topics h4 {
            font-size: 14px;
            color: #78909c;
            margin-bottom: 10px;
        }
        
        .topic-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .topic {
            padding: 6px 12px;
            background-color: #f0f7ff;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .topic:hover {
            background-color: var(--primary-blue);
            color: white;
        }
        
        /* 消息操作按钮 */
        .message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #78909c;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            color: var(--primary-blue);
        }
        
        .action-btn.like.active {
            color: var(--success);
        }
        
        .action-btn.dislike.active {
            color: var(--danger);
        }
        
        /* 输入区域 */
        .input-container {
            background: white;
            border-top: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .chat-input {
            position: relative;
            display: flex;
            margin-bottom: 12px;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 15px 50px 15px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            resize: none;
            max-height: 150px;
            min-height: 60px;
            transition: height 0.2s;
        }
        
        .input-actions {
            position: absolute;
            right: 10px;
            bottom: 15px;
            display: flex;
            gap: 12px;
        }
        
        .input-icon {
            font-size: 20px;
            color: #78909c;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .input-icon:hover {
            color: var(--primary-blue);
        }
        
        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tag {
            padding: 6px 15px;
            background-color: var(--light-blue);
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tag:hover {
            background-color: var(--primary-blue);
            color: white;
        }
        
        .send-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .send-btn:hover {
            background-color: var(--dark-blue);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            background: white;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background-color: #f5f5f5;
        }
        
        #stopBtn {
            color: #e53935;
            border-color: #e53935;
        }
        
        #stopBtn:hover {
            background-color: #ffebee;
        }
        
        /* 文件上传区域 */
        .file-upload {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .file-upload-btn {
            position: relative;
            display: inline-block;
            cursor: pointer;
            color: var(--primary-blue);
            font-size: 14px;
        }
        
        .file-upload-btn input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-name {
            margin-left: 10px;
            font-size: 13px;
            color: #78909c;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 响应式调整 */
        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
        }
        
        .menu-toggle {
            display: none;
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 100;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 150;
        }
        
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px 0;
        }
        
        .bot-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #42a5f5, var(--primary-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3);
        }
        
        .bot-avatar i {
            font-size: 60px;
            color: white;
        }
        
        .bot-intro h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--text-dark);
        }
        
        .bot-intro p {
            font-size: 16px;
            color: #546e7a;
            line-height: 1.6;
            max-width: 600px;
            margin-bottom: 25px;
        }
        
        .user-questions {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }
        
        .question-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border-left: 3px solid var(--primary-blue);
        }
        
        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .question-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .question-card p {
            font-size: 14px;
            color: #78909c;
        }



         /* Markdown渲染样式 */
          .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
              margin: 1em 0 0.5em;
              font-weight: 600;
          }
          
          .message-content p {
              margin-bottom: 1em;
              line-height: 1.6;
          }
          
          .message-content ul, .message-content ol {
              margin: 0.5em 0 1em 1.5em;
          }
          
          .message-content li {
              margin-bottom: 0.5em;
          }
          
          .message-content blockquote {
              border-left: 4px solid var(--primary-blue);
              padding-left: 15px;
              margin: 1em 0;
              color: #555;
          }
          
          .message-content table {
              border-collapse: collapse;
              margin: 1em 0;
              width: 100%;
          }
          
          .message-content th, .message-content td {
              border: 1px solid #ddd;
              padding: 8px;
              text-align: left;
          }
          
          .message-content th {
              background-color: var(--light-blue);
          }
          
          .message-content pre {
              background-color: #2d2d2d;
              border-radius: 8px;
              padding: 15px;
              overflow-x: auto;
              margin: 10px 0;
          }
          
          .message-content code {
              font-family: 'Courier New', monospace;
              font-size: 14px;
          }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-robot"></i>
            <span>Kimi智能助手</span>
        </div>
        <div class="nav-controls">
            <div class="dropdown">
                <select id="model" class="dropdown-toggle" style="background: rgba(255,255,255,0.15); color: white;">
                    <option value="kimi-k2-0711-preview">Kimi-k2-0711-preview</option>
                    <option value="kimi-k2-0301-preview">Kimi-k2-0301-preview</option>
                </select>
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <i class="fa-solid fa-plus"></i>
                <span>新建对话</span> 
            </button>
        </div>
    </nav>
    
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="history-section">
            <div class="section-title">历史对话</div>
            <ul class="history-list" id="historyList"></ul>
        </div>
        
        <div class="settings-area">
            <div class="input-group">
                <label for="apiKey">API Key</label>
                <input type="text" id="apiKey" placeholder="输入您的 API Key" value="sk-4ZuqPU3CkWHXkE9Y9Gaf0X45vsQ3fzxHYWCkMf9HU8jV7THS">
            </div>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button class="control-btn" id="clearBtn">
                    <i class="fas fa-trash"></i> 清除对话
                </button>
            </div>
        </div>
    </div>
    
    <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- 主内容区域 -->
    <main class="main-content">
        <!-- 消息容器 -->
        <div class="messages-container" id="messagesContainer">
            <!-- 欢迎屏幕 -->
            <div class="welcome-screen">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bot-intro">
                    <h2>Hi，我是Kimi智能助手</h2>
                    <p>使用小技巧:作为你的智能小伙伴，我既能写文案，想点子，又能陪你聊天，答疑解惑。</p>
                </div>
                
                <div class="user-questions">
                    <div class="question-card">
                        <h3>上海银行现在的挂牌利率是多少</h3>
                        <p>提供最新的存款利率信息</p>
                    </div>
                    <div class="question-card">
                        <h3>请结合基层"四风"隐形变相...</h3>
                        <p>分析基层工作中的形式主义问题</p>
                    </div>
                    <div class="question-card">
                        <h3>清把下面这段文字，用markdown格式化...</h3>
                        <p>文档格式转换与优化</p>
                    </div>
                    <div class="question-card">
                        <h3>什么是尸调报告</h3>
                        <p>解释专业术语的含义</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 输入区域 -->
        <div class="input-container">
            <div class="chat-input">
                <textarea id="prompt" placeholder="有问题，尽管问..." rows="2"></textarea>
                <div class="input-actions">
                    <i class="far fa-smile input-icon"></i>
                    <i class="far fa-image input-icon"></i>
                </div>
            </div>
            
            <!-- 文件上传区域 -->
            <div class="file-upload">
                <div class="file-upload-btn">
                    <i class="fas fa-paperclip"></i> 上传文件
                    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                </div>
                <div class="file-name" id="fileName"></div>
            </div>
            
            <div class="input-controls">
                <div class="quick-tags">
                    <div class="tag">支付</div>
                    <div class="tag">银联</div>
                    <div class="tag">卡金库</div>
                    <div class="tag">头条</div>
                </div>
                <div class="btn-group">
                    <button id="stopBtn" class="control-btn" style="display:none;">
                        <i class="fas fa-stop"></i> 停止接收
                    </button>
                    <button id="startBtn" class="send-btn">
                        发送 <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        $(document).ready(function() {
            // 初始化变量
            let abortController = null;
            let conversationStarted = false;
            let conversations = [];
            let currentConversationId = null;
            
            // 加载历史对话
            loadConversations();
            
            // 输入框高度自适应
            $('#prompt').on('input', function() {
                $(this).height('auto').height(this.scrollHeight);
            });
            
            // 输入框按键事件
            $('#prompt').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    $('#startBtn').click();
                }
            });
            
            // 文件上传处理
            $('#fileInput').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    $('#fileName').text(`${file.name} (${formatFileSize(file.size)})`);
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const content = event.target.result;
                        addFileMessage(file.name, content);
                    };
                    reader.readAsText(file);
                }
            });
            
            // 开始流式请求
            $('#startBtn').on('click', async function() {
                const prompt = $('#prompt').val().trim();
                if (!prompt) return;
                
                if (!conversationStarted) {
                    $('.welcome-screen').hide();
                    conversationStarted = true;
                    createNewConversation(prompt);
                }
                
                // 添加用户消息
                const userMessageId = `msg-${Date.now()}`;
                addMessage(prompt, 'user', userMessageId);
                $('#prompt').val('').height('auto');
                
                // 更新当前对话
                updateCurrentConversation(prompt, false, userMessageId);
                
                // 准备请求数据
                const apiKey = $('#apiKey').val().trim();
                const model = $('#model').val();
                
                if (!apiKey) {
                    alert('请填写 API Key');
                    return;
                }
                
                const requestData = {
                    model: model,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.6,
                    stream: true
                };
                
                // 创建 AbortController
                abortController = new AbortController();
                $('#stopBtn').show();
                
                try {
                    // 添加机器人消息占位符
                    const botMessageId = `msg-${Date.now()}`;
                    const botMessageDiv = addMessage('', 'bot', botMessageId);
                    
                    // 发送请求
                    const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData),
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                    }
                    
                    // 添加打字指示器
                    const typingIndicator = createTypingIndicator();
                    botMessageDiv.append(typingIndicator);
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';
                    let charCount = 0;
                    let botResponse = '';
                    
                    // 处理流数据
                    while (true) {
                        const { value, done } = await reader.read();
                        
                        if (done) {
                            typingIndicator.remove();
                            const tokenCounter = $('<div>').addClass('token-counter')
                                .text(`已接收: ${charCount} 个字符`);
                            botMessageDiv.append(tokenCounter);
                            $('#stopBtn').hide();
                            updateCurrentConversation(botResponse, true, botMessageId);
                            addSimilarTopics(botMessageDiv, botResponse);
                            addMessageActions(botMessageDiv, prompt, botResponse, botMessageId);
                            break;
                        }
                        
                        // 解码数据块
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // 处理完整行
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const jsonData = JSON.parse(line.substring(6));
                                    const content = jsonData.choices[0]?.delta?.content || '';
                                    
                                    if (content) {
                                        botResponse += content;
                                        charCount += content.length;
                                        
                                        // 每接收一段内容后更新渲染
                                        const contentDiv = botMessageDiv.find('.message-content');
                                        if (contentDiv.length === 0) {
                                            const newContentDiv = $('<div class="message-content">').html(renderMarkdown(botResponse));
                                            botMessageDiv.append(newContentDiv);
                                        } else {
                                            contentDiv.html(renderMarkdown(botResponse));
                                        }
                                        
                                        // 自动滚动到底部
                                        $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
                                    }
                                } catch (e) {
                                    console.error('JSON解析错误:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // 用户中断
                        const botMessageDiv = $('.bot-message').last();
                        botMessageDiv.find('.typing-indicator').remove();
                        const interrupted = $('<div>').addClass('message-content')
                            .text("（对话已中断）");
                        botMessageDiv.append(interrupted);
                    } else {
                        console.error('请求失败:', error);
                        addMessage(`请求错误: ${error.message}`, 'bot');
                    }
                    
                    $('#stopBtn').hide();
                }
            });
            
            // 停止流式请求
            $('#stopBtn').on('click', function() {
                if (abortController) {
                    abortController.abort();
                    $(this).hide();
                }
            });
            
            // 新建对话
            $('#newChatBtn').on('click', function() {
                $('#messagesContainer').empty();
                $('.welcome-screen').show();
                conversationStarted = false;
                currentConversationId = null;
                $('#stopBtn').hide();
                bindQuestionCards();
            });
            
            // 清除对话
            $('#clearBtn').on('click', function() {
                $('.message').remove();
                if (!conversationStarted) {
                    $('.welcome-screen').show();
                }
            });
            
            // 添加Markdown渲染函数
            function renderMarkdown(content) {
                // 使用marked解析Markdown
                const html = marked.parse(content);
                // 创建临时元素用于高亮代码块
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // 高亮所有代码块
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                return tempDiv.innerHTML;
            }
            // 绑定问题卡片事件
            function bindQuestionCards() {
                $('.question-card').on('click', function() {
                    $('#prompt').val($(this).find('h3').text()).trigger('input');
                });
            }
            
            bindQuestionCards();
            
            // 辅助函数：添加消息
            function addMessage(content, sender, messageId) {
                const messageDiv = $(`<div class="message ${sender}-message" id="${messageId}">`);
                const header = $(`<div class="message-header">`)
                    .html(sender === 'user' ? '<i class="fas fa-user"></i> 用户' : '<i class="fas fa-robot"></i> Kimi助手');
                
                messageDiv.append(header);
                
                if (content) {
                    // 对bot消息渲染Markdown
                    if (sender === 'bot') {
                        const contentDiv = $('<div class="message-content">').html(renderMarkdown(content));
                        messageDiv.append(contentDiv);
                        messageDiv.addClass('compact-view');
                    } else {
                        const contentDiv = $('<div class="message-content">').text(content);
                        messageDiv.append(contentDiv);
                    }
                }
                
                $('#messagesContainer').append(messageDiv);
                $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
                
                return messageDiv;
            }
            
            // 辅助函数：添加文件消息
            function addFileMessage(filename, content) {
                const messageDiv = $('<div class="message user-message">');
                const header = $('<div class="message-header">')
                    .html('<i class="fas fa-user"></i> 用户');
                
                messageDiv.append(header);
                
                const contentDiv = $('<div class="message-content">');
                const fileInfo = $('<div>').html(`<i class="fas fa-file"></i> ${filename}`).css('font-weight', 'bold');
                contentDiv.append(fileInfo);
                
                // 显示文件内容预览
                const preview = $('<div>').text(content.length > 200 ? content.substring(0, 200) + '...' : content)
                    .css({
                        'margin-top': '10px',
                        'padding': '10px',
                        'background-color': '#f9f9f9',
                        'border-radius': '8px',
                        'font-size': '14px',
                        'white-space': 'pre-wrap'
                    });
                
                contentDiv.append(preview);
                messageDiv.append(contentDiv);
                $('#messagesContainer').append(messageDiv);
                $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
            }
            
            // 辅助函数：创建打字指示器
            function createTypingIndicator() {
                return $(`
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `);
            }
            
            // 辅助函数：添加相似话题
            function addSimilarTopics(messageDiv, content) {
                const similarTopics = $('<div class="similar-topics">');
                const title = $('<h4>').text('相似话题推荐');
                similarTopics.append(title);
                
                const topicList = $('<div class="topic-list">');
               
            }
            
            // 辅助函数：添加消息操作按钮
            function addMessageActions(messageDiv, userPrompt, botResponse, messageId) {
                const actionsDiv = $('<div class="message-actions">');
                
                // 点赞按钮
                const likeBtn = $('<button class="action-btn like">')
                    .html('<i class="fas fa-thumbs-up"></i> 点赞')
                    .on('click', function() {
                        $(this).toggleClass('active');
                        dislikeBtn.removeClass('active');
                    });
                actionsDiv.append(likeBtn);
                
                // 点踩按钮
                const dislikeBtn = $('<button class="action-btn dislike">')
                    .html('<i class="fas fa-thumbs-down"></i> 点踩')
                    .on('click', function() {
                        $(this).toggleClass('active');
                        likeBtn.removeClass('active');
                    });
                actionsDiv.append(dislikeBtn);
                
                // 复制按钮
                const copyBtn = $('<button class="action-btn">')
                    .html('<i class="fas fa-copy"></i> 复制')
                    .on('click', function() {
                        navigator.clipboard.writeText(botResponse)
                            .then(() => alert('已复制到剪贴板'))
                            .catch(err => console.error('复制失败:', err));
                    });
                actionsDiv.append(copyBtn);
                
                // 刷新按钮
                const refreshBtn = $('<button class="action-btn">')
                    .html('<i class="fas fa-sync"></i> 刷新')
                    .on('click', function() {
                        $('#prompt').val(userPrompt).trigger('input');
                        $('#startBtn').click();
                    });
                actionsDiv.append(refreshBtn);
                
                // 删除按钮
                const deleteBtn = $('<button class="action-btn">')
                    .html('<i class="fas fa-trash"></i> 删除')
                    .on('click', function() {
                        messageDiv.remove();
                    });
                actionsDiv.append(deleteBtn);
                
                messageDiv.append(actionsDiv);
            }
            
            // 辅助函数：格式化文件大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 辅助函数：创建新对话
            function createNewConversation(firstMessage) {
                const conversationId = Date.now().toString();
                const conversation = {
                    id: conversationId,
                    title: firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage,
                    messages: []
                };
                
                conversations.push(conversation);
                currentConversationId = conversationId;
                saveConversations();
                renderHistoryList();
            }
            
            // 辅助函数：更新当前对话
            function updateCurrentConversation(message, isBot = false, messageId) {
                if (!currentConversationId) return;
                
                const conversation = conversations.find(c => c.id === currentConversationId);
                if (conversation) {
                    conversation.messages.push({
                        id: messageId,
                        role: isBot ? 'assistant' : 'user',
                        content: message
                    });
                    
                    if (conversation.messages.length === 1 && !isBot) {
                        conversation.title = message.length > 30 ? message.substring(0, 30) + '...' : message;
                        renderHistoryList();
                    }
                    
                    saveConversations();
                }
            }
            
            // 辅助函数：保存对话到localStorage
            function saveConversations() {
                localStorage.setItem('kimi_conversations', JSON.stringify(conversations));
            }
            
            // 辅助函数：从localStorage加载对话
            function loadConversations() {
                const saved = localStorage.getItem('kimi_conversations');
                if (saved) {
                    conversations = JSON.parse(saved);
                    renderHistoryList();
                }
            }
            
            // 辅助函数：渲染历史对话列表
            function renderHistoryList() {
                $('#historyList').empty();
                
                conversations.forEach(conversation => {
                    const li = $(`<li class="history-item ${conversation.id === currentConversationId ? 'active' : ''}">`)
                        .html(`
                            <i class="fas fa-comment"></i>
                            <span>${conversation.title}</span>
                            <i class="fas fa-trash delete-btn"></i>
                        `)
                        .on('click', () => loadConversation(conversation.id));
                    
                    li.find('.delete-btn').on('click', function(e) {
                        e.stopPropagation();
                        deleteConversation(conversation.id);
                    });
                    
                    $('#historyList').append(li);
                });
            }
            
            // 辅助函数：加载对话
            function loadConversation(id) {
                const conversation = conversations.find(c => c.id === id);
                if (!conversation) return;
                
                $('#messagesContainer').empty();
                
                conversation.messages.forEach(msg => {
                    const messageDiv = addMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user', msg.id);
                    
                    if (msg.role === 'assistant') {
                        const userMessage = conversation.messages.find(
                            m => m.role === 'user' && m.id === msg.id.replace('bot', 'user')
                        );
                        
                        if (userMessage) {
                            addMessageActions(messageDiv, userMessage.content, msg.content, msg.id);
                        }
                    }
                });
                
                currentConversationId = id;
                conversationStarted = true;
                $('.welcome-screen').hide();
                renderHistoryList();
            }
            
            // 辅助函数：删除对话
            function deleteConversation(id) {
                conversations = conversations.filter(c => c.id !== id);
                
                if (currentConversationId === id) {
                    $('#messagesContainer').empty();
                    $('.welcome-screen').show();
                    conversationStarted = false;
                    currentConversationId = null;
                    bindQuestionCards();
                }
                
                saveConversations();
                renderHistoryList();
            }
            
            // 移动端菜单切换
            $('#menuToggle').on('click', function() {
                $('.sidebar').toggleClass('active');
            });
            
            // 助手选项交互
            $('.assistant-option').on('click', function() {
                $('.assistant-option').removeClass('active');
                $(this).addClass('active');
            });
        });
    </script>
</body>
</html>