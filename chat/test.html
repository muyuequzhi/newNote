<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimi智能助手</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- 添加Markdown渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <style>
        /* 原有样式保持不变 */
        :root {
            --primary-blue: #1e88e5;
            --light-blue: #e3f2fd;
            --dark-blue: #0d47a1;
            --text-dark: #333;
            --text-light: #fff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --success: #4caf50;
            --danger: #f44336;
        }
        
        /* ... 原有样式保持不变 ... */
        
        /* 图片加载防抖解决方案 */
        .img-wrapper {
            position: relative;
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f7fa;
            transition: all 0.3s ease;
            min-height: 100px; /* 默认占位高度 */
        }
        
        .img-placeholder {
            width: 100%;
            padding-top: 56.25%; /* 16:9 宽高比 */
            background: linear-gradient(135deg, #f0f4f8, #e0e7ee);
            position: relative;
        }
        
        .img-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-blue);
            font-size: 24px;
        }
        
        .message-content img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .message-content img.loaded {
            opacity: 1;
        }
        
        /* Markdown渲染样式 */
        .message-content p {
            margin-bottom: 0.5em;
            line-height: 1.5;
        }
        
        .message-content ul, 
        .message-content ol {
            margin: 0.3em 0 0.8em 1.5em;
        }
        
        .message-content li {
            margin-bottom: 0.3em;
        }
        
        .message-content h1, 
        .message-content h2, 
        .message-content h3, 
        .message-content h4 {
            margin: 0.8em 0 0.5em;
            line-height: 1.3;
        }
        
        .message-content pre {
            margin: 0.5em 0;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
        }
        
        .message-content code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .message-content blockquote {
            border-left: 3px solid var(--primary-blue);
            padding: 5px 0 5px 15px;
            margin: 0.8em 0;
            color: #555;
            background-color: rgba(30, 136, 229, 0.05);
        }
    </style>
</head>
<body>
    <!-- 页面结构保持不变 -->
    
    <script>
        $(document).ready(function() {
            // ... 原有JS代码保持不变 ...
            
            // 添加图片加载防抖功能
            function handleImageLoading() {
                $('img').each(function() {
                    if (!this.complete || typeof this.naturalWidth === 'undefined' || this.naturalWidth === 0) {
                        // 创建占位符
                        const wrapper = $(this).closest('.img-wrapper');
                        if (wrapper.length === 0) {
                            $(this).wrap('<div class="img-wrapper"></div>');
                            $(this).before(`
                                <div class="img-placeholder">
                                    <i class="fas fa-spinner fa-spin img-loader"></i>
                                </div>
                            `);
                        }
                        
                        // 加载完成后处理
                        $(this).on('load', function() {
                            $(this).addClass('loaded');
                            $(this).prev('.img-placeholder').remove();
                        });
                        
                        // 加载失败处理
                        $(this).on('error', function() {
                            $(this).prev('.img-placeholder')
                                .html('<div style="padding:20px;text-align:center;color:#f44336">图片加载失败</div>');
                        });
                    }
                });
            }
            
            // 修改Markdown渲染函数
            function renderMarkdown(content) {
                // 使用marked解析Markdown
                const html = marked.parse(content);
                
                // 创建临时元素用于处理
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // 处理图片：添加占位符
                tempDiv.querySelectorAll('img').forEach(img => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper';
                    
                    const placeholder = document.createElement('div');
                    placeholder.className = 'img-placeholder';
                    
                    const loader = document.createElement('i');
                    loader.className = 'fas fa-spinner fa-spin img-loader';
                    
                    placeholder.appendChild(loader);
                    wrapper.appendChild(placeholder);
                    wrapper.appendChild(img);
                    
                    img.parentNode.replaceChild(wrapper, img);
                });
                
                // 高亮代码块
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                return tempDiv.innerHTML;
            }
            
            // 修改流式输出处理逻辑
            // 在流式输出处理部分，添加图片加载处理
            // 在contentDiv.html(renderMarkdown(botResponse));后添加：
            if (content) {
                // ... 原有代码 ...
                
                // 确保图片加载处理
                setTimeout(() => {
                    handleImageLoading();
                }, 100);
            }
        });
    </script>
</body>
</html>